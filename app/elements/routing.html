<script src="../../bower_components/page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {
    page('/', function () {
      checkLoggedIn()
      app.route = 'home';
    });

    page('/token/:token', function(context){
      var token = context.params.token;
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
          if(xmlhttp.status == 200){
            document.cookie = "loggedIn=true"
            document.cookie = "api_token="+xmlhttp.getResponseHeader("Cookie")
            page.redirect("/")
          }else if(xmlhttp.status == 401){
            page.redirect("/unauthorized")
          }else{
            page.redirect("/error")
          }
        }
      }

      xmlhttp.open("GET","http://localhost:8080/api/token/check/" + token,true);
      xmlhttp.send();
    })

    page('/codingGround', function () {
      checkLoggedIn()
      app.route = 'codingGround';
    });

    page('/unauthorized', function(){
      app.route = 'unauthorized';
    })

    // add #! before urls
    page({
      hashbang: true
    });

    function checkLoggedIn(){
      var loggedIn = getCookie("loggedIn")
      if(loggedIn=="" || loggedIn=="false"){
        page.redirect("/unauthorized")
      }
    }
    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
      }
      return "";
    }
  });
</script>
