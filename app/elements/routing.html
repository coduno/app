<script src="../bower_components/page/page.js"></script>
<script src="../scripts/util.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {
    page('/home', function () {
      checkLoggedIn();
      app.route = 'home';
      document.getElementById('main-page-header').innerHTML = '<home-header></home-header>';
    });

    page('/token/:token', function(context){
      var token = context.params.token;
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
          if(xmlhttp.status == 200){
            app.persistChallenge(JSON.parse(xmlhttp.response))
            page.redirect("/home")
          }else if(xmlhttp.status == 401){
            page.redirect("/unauthorized")
          }else{
            page.redirect("/error")
          }
        }
      };

      xmlhttp.withCredentials = true;
      xmlhttp.open("GET","/api/token/check/" + token,true);
      xmlhttp.send();
    });

    page('/codingGround', function () {
      checkLoggedIn();
      app.route = 'codingGround';
      document.getElementById('main-page-header').innerHTML = '<editor-header></editor-header>';
    });

    page('/unauthorized', function(){
      app.route = 'unauthorized';
    });

    // add #! before urls
    page({
      hashbang: true
    });

    function checkLoggedIn(){
      var challengeId = getCookie("challengeId")
      if(challengeId=="" || challengeId==undefined){
        page.redirect("/unauthorized")
      }
    }
  });
</script>
