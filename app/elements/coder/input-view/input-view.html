<link rel="import" href="input-view-element.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">

<link rel="import" href="/elements/common/services/user-submission-service.html">

<dom-module id="input-view">
	<style>
		:host{
			display: block;
			height: 100%;
			width: 100%;
		}
	</style>
	<template>
		<iron-ajax
			id="getTestsRequest"
			handle-as="json"
			on-response="onTestsResponse"
			on-error="onTestsError"
			method="GET"
			with-credentials="true"
			>
		</iron-ajax>
		<user-submission-service id="userSubmissionService" on-response="_onResponse" on-error="_onError"></user-submission-service>
		<p>Paste/Upload the generated output and test it.</p>
		<template is="dom-repeat" items="{{testOutputs}}">
			<input-view-element id="{{_inputId(item.id)}}"
								test-id="{{item.id}}"
								input-value="{{item.inputValue}}"
								counter="{{item.counter}}">
			</input-view-element>
		</template>
			<paper-icon-button id="runButton" icon="av:play-arrow" on-click="runTests">Run tests</paper-icon-button>
	</template>
	<script>
		Polymer({
			is: 'input-view',
			properties: {
				task: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				testOutputs: {
					type: Array,
					notify: true
				}
			},
			observers: [
				'_afterPropertiesSet(task)'
			],
			listeners: {
				'green-test': 'onGreenTest'
			},
			runTests: function(){
				this.$.userSubmissionService.submitOutput(this.task.id, this.testOutputs);
			},
			_afterPropertiesSet: function(){
				this.testOutputs = [];
				this.$.getTestsRequest.url = util.build('/tasks/' + this.task.id + '/tests');
				this.$.getTestsRequest.generateRequest();
			},
			onTestsResponse: function(r){
				var data = r.detail.response;
				this.tests = data;
				for(var i=0;i<data.length;i++){
					this.push('testOutputs', {'id': data[i].id, 'counter': i + 1});
				}
			},
			onTestsError: function(err){
				util.error(err);
			},
			_inputId: function(testId){
				return 'test-' + testId;
			},
			_onResponse: function(event, r){
				var results = r.detail.response;
				var greenTests = 0;
				for (var i = 0; i < results.length; i++){
					var testResult = results[i];
					var testInput = this.$$('#' + this._inputId(testResult.testId));
					testInput.testResult = testResult.green;
					greenTests = testResult.green ? greenTests + 1 : greenTests;
				}
				if(this.tests.length === greenTests){
					this.fire('level-completed');
				}
			},
			_onError: function(event, e){
				util.error(e);
			}
		});
	</script>
</dom-module>
