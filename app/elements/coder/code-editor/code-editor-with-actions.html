<link rel="import" href="/elements/coder/code-editor/code-editor.html">
<link rel="import" href="/elements/common/services/template-service.html">
<link rel="import" href="/elements/coder/code-editor/language-selector.html">

<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="code-editor-with-actions">
	<template>
		<style include="iron-flex iron-flex-reverse">
			:host {
				display: block;
				height: 100%;
			}

			#codeEditor {
				height: calc(100% - 60px);
			}

			#codeEditorCommands {
				height: 60px;
				border-bottom: 1px solid black;
				@apply(--layout-horizontal);
			}

			.maximized {
				position: fixed;
				top: 108px;
				right: 0;
				height: calc(100% - 120px) !important;
				width: 100%;
				z-index: 1;
			}

			#codeEditorWrapper{
				height: 100%;
				width: 100%;
				background: white;
			}

			paper-fab {
				margin: 10px;
			}

			#actions {
				position: absolute;
				bottom: 2%;
				width:100%;
				@apply(--layout-horizontal-reverse);
			}

			language-selector {
				@apply(--layout-self-center)
			}

			span {
				@apply(--layout-flex)
			}

			paper-icon-button {
				@apply(--layout-self-center)
			}
		</style>
		<template-service id="templateService" template="{{template}}"></template-service>
		<user-submission-service id="submissionService"></user-submission-service>
		<ws-element url="{{wsUrl}}"></ws-element>
		<div id="codeEditorWrapper" class$="{{codeEditorWrapperClass}}">
			<div id="codeEditorCommands">
				<language-selector task="{{task}}" language="{{languageOption}}" style="margin-left: 20px;"></language-selector>
				<span></span>
				<paper-icon-button on-click="_maximize" icon="{{maximizeIcon}}"></paper-icon-button>
			</div>
			<code-editor id="codeEditor" on-code-changed="_setCachedCode"></code-editor>
			<div id="actions">
				<paper-fab mini on-click="_goToInstructions" icon="chrome-reader-mode"></paper-fab>
				<paper-fab mini on-click="_download" icon="file-download"></paper-fab>
				<paper-fab mini on-click="_addFile" icon="file-upload"></paper-fab>
				<paper-fab mini on-click="submit" icon="av:play-arrow"></paper-fab>
			</div>
			<input type="file" name="fileToRun" id="fileToRun" on-change="_filesUploaded" style="display: none;">
		</div>
	</template>
	<script>
		Polymer({
			is: 'code-editor-with-actions',
			properties: {
				language: {
					type: String,
					notify: true,
					observer: '_languageChanged'
				},
				languageOption: {
					type: Object,
					notify: true,
					observer: '_languageOptionChanged'
				},
				task: {
					type: Object
				},
				maximizeIcon: {
					value: 'fullscreen'
				},
				template: {
					notify: true,
					observer: '_templateChanged'
				},
				wsUrl: {
					type: String,
					notify: true
				}
			},
			_goToInstructions: function(){
				window.open(this.task.instructions, '', '_blank');
			},
			_download: function(){
				window.open(this.task.description, '', '_blank');
			},
			run: function(){
				//todo: submission service
				this.fire('start-loading');
				var files = this.$codeEditor.getFiles();
				this.$.submissionService.run(this.task.id, this.language, files);
			},
			submit: function(){
				this.fire('start-loading');
				var files = this.$.codeEditor.getFiles();
				this.$.submissionService.submit(this.task.id, this.language, files);
			},
			ready: function(){
				this._setValue(this._getCachedCode());
				this.wsUrl = util.getWSUrl('/ws');
			},
			_addFile: function(){
				this.$$('#fileToRun').click();
			},
			_maximize: function(){
				if(this.codeEditorWrapperClass === 'maximized'){
					this.maximizeIcon = 'fullscreen';
					this.codeEditorWrapperClass = '';
					return;
				}
				this.codeEditorWrapperClass = 'maximized';
				this.maximizeIcon = 'fullscreen-exit';
			},
			_setValue: function(value){
				this.$$('#codeEditor').setValue(value);
			},
			_setCachedCode: function(e, code){
				if(!this.language){
					return;
				}
				localStorage.setItem(this.language, JSON.stringify(code));
			},
			_getCachedCode: function(){
				if(!this.language){
					return undefined;
				}
				return JSON.parse(localStorage.getItem(this.language));
			},
			_languageOptionChanged: function(){
				if(!this.languageOption){
					return;
				}
				this.language = this.languageOption.value;
			},
			_languageChanged: function(){
				if(this.language){
					this.$.codeEditor.language = this.language;
					var cachedCode = this._getCachedCode();
					if(cachedCode){
						this.$.codeEditor.setFilesJson(cachedCode);
						return;
					}
					this.$.codeEditor.clearFiles();
					if(!this.task || !this.task.templates || !this.language){
						return;
					}
					for(var i=0;i<this.task.templates.length;i++){
						if(this.task.templates[i].language === this.language){
							this.$.templateService.getById(this.task.templates[i].id);
							return;
						}
					}
				}
			},
			_templateChanged: function(){
				if(this.template && !this._getCachedCode()){
					this.$codeEditor.addFile(this.template);
				}
			},
			_filesUploaded: function() {
				var files = this.$$('#fileToRun').files;
				if(files.length > 0){
					this.$$('#codeEditor').setFile(files[0]);
				}
			}
		});
	</script>
</dom-module>
