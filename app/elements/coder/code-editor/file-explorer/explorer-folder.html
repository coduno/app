<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="explorer-file.html">
<link rel="import" href="explorer-item.html">

<dom-module id="explorer-folder">
	<template>
		<style include="iron-flex explorer-item"></style>
		<div id="wrapper" class="item-wrapper">
			<iron-icon icon="folder" ></iron-icon>
			<template is="dom-if" if="{{meta.editMode}}">
				<input id="nameInput" type="text" value="{{newName::input}}" on-keyup="_confirmRename" autofocus>
			</template>
			<template is="dom-if" if="{{!meta.editMode}}">
				<div class="item-name">{{meta.name}}</div>
			</template>
		</div>
		<template is="dom-repeat" items="{{meta.children}}">
			<template is="dom-if" if="{{item.isFolder}}">
				<explorer-folder meta="{{item}}" on-rename="_checkRename" on-delete="_deleteChild"></explorer-folder>
			</template>
			<template is="dom-if" if="{{!item.isFolder}}">
				<explorer-file meta="{{item}}" on-rename="_checkRename" on-delete="_deleteChild"></explorer-file>
			</template>
		</template>
		<paper-toast id="toast"></paper-toast>
	</template>
	<script type="application/javascript" src="/scripts/behaviors/file-explorer-item-behavior.js"></script>
	<script>
		Polymer({
			is: 'explorer-folder',
			behaviors: [
				Behaviors.FileExplorerItemBehavior
			],
			addFolder: function(){
				if (!this.meta.children){
					this.set('meta.children', []);
				}
				var newFolder = {
					'isFolder': true,
					'order': this.meta.order + 1,
					'editMode': true,
					'name': ''
				};
				this.push('meta.children', newFolder);
			},
			addFile: function(){
				if (!this.meta.children){
					this.set('meta.children', []);
				}
				var newFile = {
					'isFolder': false,
					'order': this.meta.order + 1,
					'editMode': true,
					'name': ''
				};
				this.push('meta.children', newFile);
			},
			_checkRename: function(e, el){
				var conflict = this.isRenameConflict(el.newName, el.meta.isFolder);
				el.finishRename(conflict);
			},
			isRenameConflict: function(name, isFolder){
				for (var i = 0; i < this.meta.children.length; i++){
					if (this.meta.children[i].name === name && this.meta.children[i].isFolder === isFolder){
						return true;
					}
				}
				return false;
			},
			getSquashedFilesAsJson: function(){
				if (!this.meta.children){
					return [];
				}
				var files = [];
				for (var i = 0; i < this.meta.children.length; i++){
					var el = this.meta.children[i];
					if (!el.isFolder){
						files.push({
							'name': el.name,
							'content': el.content
						});
					}else{
						var cFiles = [];
						this._getSquashedFilesForFolder(el, cFiles, '');
						files = files.concat(cFiles);
					}
				}
				return files;
			},
			_getSquashedFilesForFolder: function(folder, files, prefix){
				var cPrefix = prefix + folder.name + '/';
				for(var i = 0; i < folder.children.length; i++){
					var el = folder.children[i];
					if (el.isFolder){
						this._getSquashedFilesForFolder(el, files, cPrefix);
					}else{
						files.push({
							'name': cPrefix + el.name,
							'content': el.content
						});
					}
				}
			},
			_deleteChild: function(e, childMeta){
				var index = this.meta.children.indexOf(childMeta);
				if (index < 0){
					return;
				}
				this.splice('meta.children', index, 1);
			},
			putSelectedFile: function(filePath, content){
				if (!this.meta.children){
					this.set('meta.children', []);
				}
				var separator = filePath.indexOf('/');
				if (separator === -1){
					this.push('meta.children', {
						'name': filePath,
						'content': content,
						'selected': true,
						'isFolder': false,
						'order': this.meta.order + 1
					});
					return;
				}

				var folderName = filePath.substring(0, separator);
				var firstChild = {
					'name': folderName,
					'isFolder': true,
					'order': this.meta.order + 1,
					'children': []
				};
				filePath = filePath.substring(separator + 1, filePath.length);
				separator = filePath.indexOf('/');
				var parent = firstChild;

				while (separator !== -1){
					folderName = filePath.substring(0, separator);
					var childFolder = {
						'name': folderName,
						'isFolder': true,
						'order': parent.order + 1,
						'children': []
					};
					parent.children.push(childFolder);
					parent = childFolder;
					filePath = filePath.substring(separator + 1, filePath.length);
					separator = filePath.indexOf('/');
				}
				var newFile = {
					'name': filePath,
					'content': content,
					'isFolder': false,
					'order': parent.order + 1,
					'selected': true
				};
				parent.children.push(newFile);
				this.push('meta.children', firstChild);
			}
		});
	</script>
</dom-module>