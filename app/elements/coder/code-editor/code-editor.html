<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="file-explorer/explorer-item.html">
<link rel="import" href="file-explorer/context-menu.html">

<dom-module id="code-editor">
	<style include="iron-flex">
		:host {
			display: block;
			height: 100%;
		}
		#editor {
			height: calc(100% - 36px);
			z-index: 0;
		}
		.container {
			height: 100%;
			@apply(--layout-horizontal);
		}
		.editor-container {
			@apply(--layout-flex);
			height: 100%;
			@apply(--layout-vertical);
		}
		.explorer-container {
			width: 200px;
		}
	</style>
	<template>
		<context-menu id="contextMenu"></context-menu>
		<div class="container">
			<div class="explorer-container" style$="{{explorerStyle}}">
				<explorer-item id="rootFolder" tree="{{jsonTree(tree)}}" path="" name=""></explorer-item>
			</div>
			<div class="editor-container">
				<div>
					<paper-icon-button icon="{{toggleExplorerIcon}}" on-click="_toggle"></paper-icon-button>
				</div>
				<div id="editor"></div>
			</div>
		</div>
	</template>
	<script src="../../../bower_components/ace-min-noconflict/ace.js" type="application/javascript"></script>
	<script src="../../../bower_components/ace-min-noconflict/theme-chrome.js" type="application/javascript"></script>
	<script src="../../../bower_components/ace-min-noconflict/ext-language_tools.js" type="application/javascript"></script>
	<script src="../../../scripts/tree.js" type="application/javascript"></script>

	<script>
		/*global ace:false */
		Polymer({
			is: 'code-editor',
			properties: {
				language: {
					type: String,
					reflectToAttribute: true,
					observer: '_languageChanged'
				},
				toggleExplorerIcon: {
					type: String,
					notify: true,
					value: 'chevron-left'
				},
				tree: {
					type: Object,
					notify: true,
					value: function() {
						return new Tree({'y.txt': 'Hi!', 'x': new Tree({'a.txt': 'Ho!', 'b.txt': 'Hu!'})});
					},
					observer: '_treeChanged'
				},
				explorerStyle: {
					type: String,
					value: ''
				},
				selectedFile: {
					type: Object,
					notify: true
				}
			},
			listeners: {
				'show-menu': '_showMenu',
				'file-selected': '_fileSelected'
			},
			ready: function() {
				this._addContextMenuListener();
				ace.require('ace/ext/language_tools');
				this.$.editor = ace.edit(this.$.editor);
				this.$.editor.setTheme('ace/theme/chrome');
				this.$.editor.setOptions({
					enableBasicAutocompletion: true
				});
				var that = this;
				this.$.editor.getSession().on('change', function() {
					var content = that.$.editor.getValue();
					that.selectedFile.setContent(content);
					that.fire('code-changed', that.tree);
				});
				this.$.editor.commands.addCommand({
					name: 'run',
					bindKey: {
						win: 'Ctrl-Enter'
					},
					exec: function() {
						that.fire('run-code');
					},
					readOnly: true
				});
				this.$.editor.$blockScrolling = Infinity;
				//this.clearFiles();
			},
			_treeChanged: function(current, previous) {
				console.log('Tree changed from', Tree.toJSON(previous), 'to', Tree.toJSON(current));
			},
			jsonTree: function(tree) {
				var result = Tree.toJSON(tree);
				console.log('Converted tree', tree, 'to', result);
				return JSON.stringify(result);
			},
			clearFiles: function() {
				this.tree = new Tree({});
				this.notifyPath('tree');
				if (!!this.selectedFile) {
					this.selectedFile.unselectFile();
					this.selectedFile = undefined;
				}
			},
			_fileSelected: function(e, detail) {
				if (!!this.selectedFile) {
					this.selectedFile.unselectFile();
				}
				this.selectedFile = detail;
				this.setValue(this.selectedFile.getContent());
			},
			_toggle: function() {
				if (this.toggleExplorerIcon === 'chevron-left') {
					this.explorerStyle = 'display: none';
					this.toggleExplorerIcon = 'chevron-right';
				} else {
					this.explorerStyle = '';
					this.toggleExplorerIcon = 'chevron-left';
				}
			},
			setFilesJson: function(rootFolder) {
				this.tree = Tree.fromSON(rootFolder);
				this.notifyPath('tree');
			},
			getFiles: function() {
				return this.tree.all().map(function(it) {
					var blob = new Blob([this.tree.get(it).value]);
					blob.name = it;
					return blob;
				}, this);
			},
			setValue: function(text) {
				this.$.editor.getSession().setValue(text);
			},
			addFile: function(f) {
				var fr = new FileReader();
				var that = this;
				fr.onload = function(e) {
					that.tree.add(f.name, e.target.result);
				};
				fr.readAsText(f);
			},
			_languageChanged: function() {
				if (this.language) {
					this._setMode(this.language);
				}
			},
			_setMode: function(lang) {
				var languageModeMap = {
					'c':      'c_cpp',
					'cpp':    'c_cpp',
					'csharp': 'csharp',
					'java':   'java',
					'js':     'javascript',
					'py':     'python',
					'go':     'golang',
					'scala':  'scala',
					'groovy': 'groovy',
					'php':    'php'
				};
				this.$.editor.getSession().setMode('ace/mode/' + (languageModeMap[lang] || 'text'));
			},
			_showMenu: function(event, data) {
				this.$.contextMenu.showMenu(data);
			},
			_addContextMenuListener: function() {
				var that = this;
				document.addEventListener('click', function(e) {
					if (that._clickInsideElement(e, 'context-menu')) {
						return;
					}
					if (that._clickInsideElement(e, 'explorer-folder')) {
						return;
					}
					document.querySelector('context-menu').hideMenu();
				});
			},
			_clickInsideElement: function(e, elName) {
				elName = elName.toLowerCase();
				var el = e.srcElement || e.target;
				if (el.tagName.toLowerCase() === elName) {
					return el;
				}

				while (!!(el = el.parentNode)) {
					if (!!el.tagName && el.tagName.toLowerCase() === elName) {
						return el;
					}
				}

				return false;
			}
		});
	</script>
</dom-module>
