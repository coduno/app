<link rel="import" href="/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="/bower_components/iron-icons/communication-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="/elements/common/data-providers/challenge/challenges-provider.html"/>
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<dom-module id="available-challenges-table">
	<style include="iron-flex">
		:host {
			display: block;
			height: 100%;
		}
		paper-icon-button {
			@apply(--layout-self-center);
		}
	</style>
	<template>
		<iron-ajax id="registerRequest"
			method="PUT"
			handle-as="text"
			content-type="application/json"
			with-credentials="true"
			on-response="_onResponse"
			on-error="_onError">
		</iron-ajax>
		<challenges-provider data="{{challenges}}"></challenges-provider>
		<vaadin-grid id="availableChallengesGrid" class="fullHeight" items="[[challenges]]" on-selected-items-changed="_selectedItemsChanged">
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Organization</th>
						<th>Start date</th>
						<th>End date</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<colgroup>
					<col name="challenge.name"/>
					<col name="challenge.organization.name"/>
					<col name="challenge.startDate"/>
					<col name="challenge.endDate"/>
					<col name="status"/>
					<col name="challenge.canonicalName"/>
				</colgroup>
			</table>
		</vaadin-grid>
		<paper-toast id="toast" text="{{toastText}}"></paper-toast>
	</template>
	<script>
		Polymer({
			is: 'available-challenges-table',
			properties: {
				isAdmin: {
					value: true
				}
			},
			observers: [
				'_dataChanged(challenges)'
			],
			_selectedItemsChanged: function(){
				var selected = this.$.availableChallengesGrid.selection.selected();
				if(!this.clickedOnOption && !!selected && selected.length > 0){
					var dto = this.challenges[selected[0]];
					if(dto.status === 'REGISTERED'||dto.status === 'IN_PROGRESS'||dto.status === 'INVITED'){
						page('/contest/' + dto.challenge.id);
					}
					return;
				}
				this.clickedOnOption = false;
			},
			_dataChanged: function(){
				var element = this;
				this.$.availableChallengesGrid.columns[2].renderer = element._formatDate;
				this.$.availableChallengesGrid.columns[3].renderer = element._formatDate;
				this.$.availableChallengesGrid.columns[4].renderer = function(cell){
					cell.element.innerHTML = '';
					cell.element.appendChild(element._createIconButton(element._iconForStatus(cell.data)));
				};
				this.$.availableChallengesGrid.columns[5].renderer = function(cell){
					cell.element.innerHTML = '';
					var dto = cell.row.data;
					if(dto.status !== 'OPEN'){
						return;
					}
					cell.element.appendChild(element._createButton('Register', function(){
						element._registerTo(dto.challenge.canonicalName);
						element.clickedOnOption = true;
					}));
				};
				this.$.availableChallengesGrid.refreshItems();
			},
			_iconForStatus: function(status){
				switch(status){
					case 'OPEN':
						return 'radio-button-unchecked';
					case 'INVITED':
						return 'communication:mail-outline';
					case 'REGISTERED':
						return 'notification:event-available';
					case 'IN_PROGRESS':
						return 'hourglass-empty';
					case 'COMPLETED':
						return 'done-all';
				}
				return '';
			},
			_registerTo: function(canonicalName){
				this.$.registerRequest.url = util.build('/challenges/' + canonicalName + '/register');
				this.$.registerRequest.generateRequest();
			},
			_formatDate: function(cell){
				if(!cell.data){
					return '';
				}
				cell.element.innerHTML = util.formatDate(cell.data);
			},
			_createButton: function(label, clickListener){
				var button = document.createElement('paper-button');
				Polymer.dom(button).textContent = label;
				button.addEventListener('click', clickListener);
				button.raised = true;
				return button;
			},
			_createIconButton: function(icon, clickListener){
				var button = document.createElement('paper-icon-button');
				button.icon = icon;
				button.addEventListener('click', clickListener);
				return button;
			},
			_onResponse: function(){
				this.toastText = 'You registered successfully.';
				this.$.toast.show();
				this.$$('challenges-provider').refresh();
			},
			_onError: function(e, r){
				this.toastText = 'An error occured when processing your request.';
				if(!!r.request.xhr.responseText){
					this.toastText = r.request.xhr.responseText;
				}
				this.$.toast.show();
			}
		});
	</script>
</dom-module>
