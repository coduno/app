<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="challenge-page">
	<style include="iron-flex">
		:host {
			display: block;
			height: 100%;
		}
		#challenge {
			height: 100%;
		}

		#startChallengeCard{
			margin-top: 60px;
			width:35%;
		}
		#remainingTime {
			height: 100%;
		}

		time-until-challenge {
			margin-top: 60px;
			width:35%;
			@apply(--layout-horizontal);
		}
	</style>
	<template>
		<challenge-by-canonical-name-provider canonical-name="[[canonicalName]]" data="{{challenge}}"></challenge-by-canonical-name-provider>
		<challenge-template-by-challenge-canonical-name-provider canonical-name="[[canonicalName]]" data="{{challengeTemplate}}"></challenge-template-by-challenge-canonical-name-provider>
		<result-service id="resultService" result="{{result}}"></result-service>

		<div id="timeUntilChallenge" style="{{remainingTimeStyle}}">
			<span class="flex"></span>
			<time-until-challenge class="self-center" challenge="{{challenge}}" on-start-challenge="_displayChallengeTemplate"></time-until-challenge>
			<span class="flex"></span>
		</div>
		<div id="challenge" style$="{{contentStyle}}">
			<paper-material id="startChallengeCard" elevation="1" class="card">
				<div class="flex">
					<challenge-display challenge="{{challengeTemplate}}"></challenge-display>
					<paper-button raised on-click="startChallenge">Go</paper-button>
				</div>
			</paper-material>
		</div>
	</template>
	<script type="application/javascript" src="../../../../scripts/behaviors/loading-behavior.js"></script>
	<script>
		Polymer({
			is: 'challenge-page',
			behaviors: [
				Behaviors.LoadingBehavior
			],
			properties: {
				result: {
					type: Object,
					observer: '_resultLoaded'
				},
				challengeTemplate: {
					type: Object,
					observer: '_challengeTemplateLoaded'
				},
				challenge: {
					type: Object,
					observer: '_challengeLoaded'
				},
				contentStyle:{
					type: String,
					value: 'display: none;'
				},
				remainingTimeStyle:{
					type: String,
					value: 'display: none;'
				}
			},
			observers: [
				'afterPropertiesSet(canonicalName)'
			],
			_challengeLoaded: function(){
				if(!this.challenge.startDate || ((this.challenge.startDate * 1000) - new Date().getTime()) <= 0){
					this._displayChallengeTemplate();
				}else{
					this.stopAppLoading();
					this.remainingTimeStyle = '';
				}
			},
			_resultLoaded: function(){
				if(this.result){
					localStorage.result = this.result.id;
					this.replaceContent();
				}else{
					this.stopAppLoading();
					this.contentStyle = '';
				}
			},
			_challengeTemplateLoaded: function(){
				this.$.resultService.getMyResultByChallengeId(this.challenge.id);
			},
			_displayChallengeTemplate: function(){
				this.remainingTimeStyle = 'display: none;';
				this.$.timeUntilChallenge.innerHTML = '';
				this.$$('challenge-template-by-challenge-canonical-name-provider').refresh();
			},
			afterPropertiesSet: function(){
				this.startAppLoading();
			},
			startChallenge: function() {
				this.$.resultService.post(this.challenge.id);
			},
			replaceContent: function(){
				var webInterface = document.createElement(this.challengeTemplate.endpoint.component);
				//TODO: for the dear love of god, we must refactor at least the names here
				webInterface.challengeTemplate = this.challengeTemplate;
				webInterface.challenge = this.challenge;
				webInterface.result = this.result;
				this.$.challenge.innerHTML = '';
				this.$.challenge.appendChild(webInterface);
				this.contentStyle = '';
			}
		});
	</script>
</dom-module>
