<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">

<link rel="import" href="/elements/common/services/challenge-service.html">
<link rel="import" href="/elements/common/services/invitation-service.html">
<link rel="import" href="/elements/common/description-list/description-list.html">
<link rel="import" href="/elements/common/description-list/description-list-item.html">
<link rel="import" href="/elements/common/leaderboard/challenge-leaderboard.html">
<link rel="import" href="/elements/company/candidate/invite/invite-candidates.html">

<dom-module id="challenge-detail">
	<style include="iron-flex">
		.card h1 {
			padding: 20px 0;
		}

		.card h4 {
			padding: 20px 0;
		}
		paper-material {
			margin: 16px;
		}
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
		}
		th, td {
			padding: 5px;
		}
		#wrapper {
			@apply(--layout-vertical);
		}
		.layout-horizontal {
			@apply(--layout-horizontal);
		}

		.flex {
			@apply(--layout-flex);
		}
	</style>
	<template>
		<challenge-service id="challengeService" challenge="{{challenge}}"></challenge-service>
		<invitation-service id="invitationService" invitations="{{invitations}}"></invitation-service>

		<div id="wrapper" class="grid mainContent">
				<paper-material class="card" elevation="1">
					<h1>{{challenge.name}}</h1>
					<description-list>
						<description-list-item label="Canonical name" value="{{challenge.canonicalName}}"></description-list-item>
						<description-list-item label="Start date" value="{{challenge.startDate}}" date></description-list-item>
						<description-list-item label="End date" value="{{challenge.endDate}}" date></description-list-item>
					</description-list>
				</paper-material>

				<paper-material class="card">
					<div class="layout-horizontal">
						<h3 class="flex">Invited users</h3>
						<paper-button on-click="inviteCandidates">
							<iron-icon icon="{{inviteIcon}}"></iron-icon>
							Invite candidates
						</paper-button>
					</div>
					<invite-candidates
						id="inviteCandidates"
						style="display: none"
						challenge-id="{{challenge.id}}"
						on-invitation-sent="_onInvitationSent">
					</invite-candidates>
					<table style="width:100%">
						<tr>
							<th>Username</th>
							<th>Email</th>
							<th>Token</th>
							<th>Started</th>
							<th>Expire</th>
						</tr>
						<template is="dom-repeat" items="{{invitations}}">
							<tr>
								<td>{{item.username}}</td>
								<td>{{item.email}}</td>
								<td>{{item.token}}</td>
								<td>{{_formatDate(item.started)}}</td>
								<td>{{_formatDate(item.expire)}}</td>
							</tr>
						</template>
					</table>
				</paper-material>
			<paper-material class="card">
				<challenge-leaderboard challenge-id="{{challengeId}}"></challenge-leaderboard>
			</paper-material>
		</div>
	</template>
	<script>
		Polymer({
			is: 'challenge-detail',
			properties: {
				challenge: {
					type: Object,
					notify: true
				},
				leaderboard: {
					type: Array,
					notify: true
				},
				challengeId: {
					reflectToAttribute: true,
					observer: '_challengeIdChanged'
				},
				invitations: {
					type: Array
				}
			},
			_challengeIdChanged: function(){
				this._refresh();
				this.inviteIcon = 'add';
			},
			_refresh: function(){
				this.$.challengeService.getById(this.challengeId);
				this.$.invitationService.getByChallengeId(this.challengeId);
			},
			_formatDate: function(date){
				if (!!date){
					return util.formatDate(date);
				}
			},
			inviteCandidates: function(){
				if (!this.showInvitation){
					this.inviteIcon = 'remove';
					this.$.inviteCandidates.style.display = '';
					this.$.inviteCandidates.reset();
				}else{
					this.inviteIcon = 'add';
					this.$.inviteCandidates.style.display = 'none';
				}
				this.showInvitation = !this.showInvitation;
			},
			_onInvitationSent: function(){
				this.$.inviteCandidates.reset();
				this._refresh();
			}
		});
	</script>
</dom-module>
