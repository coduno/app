<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="template-service">
	<template>
		<iron-ajax
			id="download"
			method="GET"
			handle-as="blob"
			last-response="{{template}}"
			on-response="_onTemplate"
			on-error="_onError">
		</iron-ajax>
		<iron-ajax
			id="getOne"
			method="GET"
			handle-as="json"
			with-credentials="true"
			on-response="_onGetOne"
			on-error="_onError">
		</iron-ajax>
	</template>
	<script type="application/javascript" src="../../../scripts/behaviors/service-behavior.js"></script>
	<script>
		Polymer({
			is: 'template-service',
			behaviors: [
				Behaviors.ServiceBehavior
			],
			properties: {
				tree: {
					type: Object,
					reflectToAttribute: true,
					notify: true
				}
			},
			getById: function(id) {
				this.$.getOne.url = util.build('/templates/' + id);
				this.$.getOne.generateRequest();
			},
			download: function(url) {
				this.$.download.url = url;
				this.$.download.generateRequest();
			},
			_onGetOne: function(r) {
				var tree = new Tree({});
				for (var it in r.detail.response) {
					files.push()
				}
				this.download(r.detail.response[0]);
			},
			_onTemplate: function(r) {
				this.template = r.detail.response;
			}
			getTemplates: function(language) {
				this.app.startLoading();
				this.templates = [];
				this.$.getTemplateList.url = util.build('/tasks/' + this.task.id + '/templates' + (language ? '?language=' + language : ''));
				this.$.getTemplateList.generateRequest();
			},
			_onList: function(e) {
				var urls = e.detail.response;
				if (!urls || urls.length === 0) {
					// No template available.
					this.app.stopLoading();
					return;
				}
				this.templateCount = urls.length;
				for (var i = 0; i < urls.length; i++) {
					this.$.getTemplate.url = urls[i];
					this.$.getTemplate.generateRequest();
				}
			},
			_onTemplate: function(e, req) {
				// NOTE(flowlo): This matches a sensible subset of
				// Content-Disposition filename parameters. It diverges
				// from the spec as it does not allow omitting quotes if
				// the filename contains no space (because there is no
				// support for lookbehinds in JS RegExes), and also is a
				// bit more strict with path names (only allows '/') and
				// special chars (only allows '.'). So a colon in a
				// filename won't match for example.
				var match = /filename\s*=\s*"([\w\.\/]+)"/.exec(
					req.xhr.getResponseHeader('Content-Disposition')
				);
				if (!match) {
					console.log('Got malformed Content-Disposition!');
					this.templateCount--;
					return;
				}
				e.detail.response.name = match[1];
				this.templates.push(e.detail.response);
				if (this.templateCount <= this.templates.length) {
					this.fire('templates', this.templates);
				}
			}
		});
	</script>
</dom-module>
