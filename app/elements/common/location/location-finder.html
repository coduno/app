<dom-module id="location-finder">
	<template>
		<style>
			#container {
				height: 400px;
				width: 100%;
			}
			#map {
				height: 100%;
			}
			.controls {
				background-color: #fff;
				border-radius: 2px;
				border: 1px solid transparent;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
				box-sizing: border-box;
				font-family: Roboto;
				font-size: 15px;
				font-weight: 300;
				height: 29px;
				margin-left: 17px;
				margin-top: 10px;
				outline: none;
				padding: 0 11px 0 13px;
				text-overflow: ellipsis;
				width: 400px;
			}

			.controls:focus {
				border-color: #4d90fe;
			}
		</style>
		<div id="container">
			<input id="pacInput" class="controls" type="text" placeholder="Enter a location">
			<div id="map"></div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'location-finder',
			properties: {
				selectedLocation: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				center: {
					type: Object,
					notify: true,
					value: function() {
						// If the user does not allow us to center around his location, center the map around Viena.
						return {
							lat : 48.215876,
							lng : 16.389119
						};
					}
				}
			},
			observers: [
				'_recenterMap(center)'
			],
			_recenterMap: function(){
				if (!!this.map){
					this.map.setCenter(this.center);
				} else {
					setTimeout(this.initMap(), 1);
				}
			},
			ready: function(){
				this._getDefaultCoordinates();
			},
			show: function(recenter){
				this.$.container.style.display = '';
				this.initMap();
				this.selectedLocation = null;
				this.$.pacInput.value = null;
				if (!!recenter) {
					this._recenterMap();
				}
			},
			hide: function(){
				this.$.container.style.display = 'none';
			},
			initMap: function() {
				var self = this;
				var map = new google.maps.Map(this.$.map, {
					center: self.center,
					zoom: 13
				});

				var input = this.$.pacInput;

				var autocomplete = new google.maps.places.Autocomplete(input);
				autocomplete.bindTo('bounds', map);

				map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

				var infowindow = new google.maps.InfoWindow();
				var marker = new google.maps.Marker({
					map: map
				});
				marker.addListener('click', function() {
					infowindow.open(map, marker);
				});

				autocomplete.addListener('place_changed', function() {
					infowindow.close();
					var place = autocomplete.getPlace();
					if (!place.geometry) {
						return;
					}

					if (place.geometry.viewport) {
						map.fitBounds(place.geometry.viewport);
					} else {
						map.setCenter(place.geometry.location);
						map.setZoom(17);
					}

					// Set the position of the marker using the place ID and location.
					marker.setPlace({
						placeId: place.place_id,
						location: place.geometry.location
					});
					marker.setVisible(true);

					infowindow.setContent('<div><strong>' + place.name + '</strong><br>' +
						'Place ID: ' + place.place_id + '<br>' +
						place.formatted_address);
					infowindow.open(map, marker);
					self.selectedLocation = {
						'name': place.name,
						'placeId': place.place_id,
						'latitude': place.geometry.location.lat(),
						'longitude': place.geometry.location.lng()
					};
				});
				this.map = map;
			},
			_getDefaultCoordinates(){
				//Try to get the user's location to center the map around him.
				var self = this;
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position){
						self.center = {
							lat: position.coords.latitude,
							lng: position.coords.longitude
						};
					});
				}
			}
		})
	</script>
</dom-module>