<link rel="import" href="../styles/coduno.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">

<dom-module id="app-element">
	<style include="coduno-style">
		:host {
			display: block;
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
		}
	</style>
	<template>
		<google-maps-api
			api-key="[[apiConfig.apiKey]]"
			version="[[apiConfig.version]]">
		</google-maps-api>
		<paper-header-panel class="fullHeight">
			<app-nav id="appNav" user="{{user}}"></app-nav>
			<div id="sections" class="content">
			</div>
		</paper-header-panel>

		<!-- TODO(victorbalan): enable cache in production -->
		<!--
		<platinum-sw-register
			auto-register
			clients-claim
			skip-waiting
			on-service-worker-installed="displayInstalledToast"
		>
			<platinum-sw-cache default-cache-strategy="networkFirst" precache-file="precache.json"></platinum-sw-cache>
		</platinum-sw-register>
		 -->
	</template>
	<script>
		Polymer({
			is: 'app-element',
			properties: {
				apiConfig: {
					type : Object,
					notify: true,
					value: function() {
						var val = {version: '3.24'};
						// This api key for the maps api will only work on our production and staging enviornment
						// so using it locally(or any other place for that matter) will only result in errors.
						// No api key is needed for local development.
						if (location.origin.indexOf('localhost') === -1) {
							val.apiKey = 'AIzaSyCnqlcAd2M-qW20SDsghrBOOLvs144c3og';
						}
						return val;
					}
				},
				selected: {
					type: String,
					notify: true,
					value: -1
				},
				error: {
					type: Object,
					notify: true
				},
				user: {
					type: Object,
					notify: true,
					redlectToAttribute: true,
					value: {}
				},
				inProgressRequests: {
					value: 0
				}
			},
			ready: function(){
				this.initUserInfo = true;
				var element = this;
				// See https://github.com/Polymer/polymer/issues/1381
				window.addEventListener('WebComponentsReady', function() {
					// imports are loaded and elements have been registered
					if(element.initUserInfo){
						element.initializeUserInfo();
					}
				});
			},
			initializeUserInfo: function(){
				var defaultUserError = function(){
					page('/login');
				}
				var self = this;
				var cookieService = document.createElement('cookie-service');
				cookieService.addEventListener('user-ok', function(e){
					self.user = e.detail;
					self.refreshMenu();
					if(!!self.customUserOk){
						self.customUserOk(e);
						self.customUserOk = null;
					}
				});
				cookieService.addEventListener('user-error', function(){
					if(!!self.customUserError){
						self.customUserError();
						self.customUserError = null;
						return;
					}
					defaultUserError();
				});
				cookieService.login();
			},
			startLoading: function(){
				this.inProgressRequests ++;
				if(this.inProgressRequests > 1){
					return;
				}
				this.$.sections.style.display = 'none';
			},
			stopLoading: function(){
				this.inProgressRequests --;
				if(this.inProgressRequests > 0){
					return;
				}
				this.$.sections.style.display = '';
			},
			login: function(user) {
				this.setUser(user);
				page('/');
			},
			logout: function() {
				this.user = null;
				localStorage.clear();
				this.refreshMenu();
				page('/login');
			},
			setUser: function(user){
				this.user = user;
				this.refreshMenu();
			},
			refreshMenu: function() {
				this.$.appNav.refresh();
			},
			displayInstalledToast: function() {
				console.log('Caching complete.');
			},
			inviteByToken: function(token){
				var invitationRequest = document.createElement('iron-ajax');
				invitationRequest.withCredentials = true;
				invitationRequest.url = util.build('/invite/auth/' + token);
				var self = this;
				invitationRequest.addEventListener('response', function(r){
					self.initializeUserInfo();
					page('/contest/' + r.detail.response);
				});
				invitationRequest.generateRequest();
			},
			swapContent: function(element){
				this.$$('#sections').innerHTML = '';
				this.$$('#sections').appendChild(element);
			}
		});
	</script>
</dom-module>
